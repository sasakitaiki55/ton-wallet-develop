!function(e){var t={};function s(a){if(t[a])return t[a].exports;var o=t[a]={i:a,l:!1,exports:{}};return e[a].call(o.exports,o,o.exports,s),o.l=!0,o.exports}s.m=e,s.c=t,s.d=function(e,t,a){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(s.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)s.d(a,o,function(t){return e[t]}.bind(null,o));return a},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t){let s=null,a=null;const o=[],n=()=>{chrome.windows.create({url:"popup.html",type:"popup",width:400,height:600,top:0,left:window.innerWidth-400},e=>{this._popupId=e.id})},i=TonWeb.utils.BN,r=TonWeb.utils.nacl,l=TonWeb.utils.Address,d=TonWeb.utils.fromNano;async function c(e){const t=(new TextEncoder).encode(e);return TonWeb.utils.bytesToBase64(new Uint8Array(await crypto.subtle.digest("SHA-256",t)))}const h=window.location.href.indexOf("testnet")>-1;class w{constructor(){this.myAddress=null,this.publicKeyHex=null,this.myMnemonicWords=null,this.balance=null,this.walletContract=null,this.transactions=[],this.updateIntervalId=0,this.lastTransactionTime=0,this.isContractInitialized=!1,this.sendingData=null,this.processingVisible=!1,this.ledgerApp=null,this.isLedger=!1,window.view&&(window.view.controller=this);this.sendToView("setIsTestnet",h),this.ton=new TonWeb(new TonWeb.HttpProvider(h?"https://testnet.toncenter.com/api/v2/jsonRPC":"https://toncenter.com/api/v2/jsonRPC")),this.myAddress=localStorage.getItem("address"),this.myAddress&&localStorage.getItem("words")&&localStorage.getItem("pwdHash")?("true"===localStorage.getItem("isLedger")&&(this.isLedger=!0,this.publicKeyHex=localStorage.getItem("publicKey"),this.sendToView("setIsLedger",this.isLedger)),this.showMain()):(localStorage.clear(),this.sendToView("showScreen",{name:"start"}))}static async wordsToPrivateKey(e){const t=await TonWeb.mnemonic.mnemonicToKeyPair(e);return TonWeb.utils.bytesToBase64(t.secretKey.slice(0,32))}static async saveWords(e,t){localStorage.setItem("words",await async function(e,t){const s=(new TextEncoder).encode(t),a=await crypto.subtle.digest("SHA-256",s),o=crypto.getRandomValues(new Uint8Array(12)),n={name:"AES-GCM",iv:o},i=await crypto.subtle.importKey("raw",a,n,!1,["encrypt"]),r=(new TextEncoder).encode(e),l=await crypto.subtle.encrypt(n,i,r),d=Array.from(new Uint8Array(l)).map(e=>String.fromCharCode(e)).join(""),c=btoa(d);return Array.from(o).map(e=>("00"+e.toString(16)).slice(-2)).join("")+c}(e.join(","),t))}static async loadWords(e){return(await async function(e,t){const s=(new TextEncoder).encode(t),a=await crypto.subtle.digest("SHA-256",s),o=e.slice(0,24).match(/.{2}/g).map(e=>parseInt(e,16)),n={name:"AES-GCM",iv:new Uint8Array(o)},i=await crypto.subtle.importKey("raw",a,n,!1,["decrypt"]),r=atob(e.slice(24)),l=new Uint8Array(r.match(/[\s\S]/g).map(e=>e.charCodeAt(0))),d=await crypto.subtle.decrypt(n,i,l);return(new TextDecoder).decode(d)}(localStorage.getItem("words"),e)).split(",")}async getWallet(){return this.ton.provider.getWalletInfo(this.myAddress)}checkContractInitialized(e){return"active"===e.account_state}getBalance(e){return new i(e.balance)}async getTransactions(e=20){function t(e){if(!e.msg_data)return"";if("msg.dataText"!==e.msg_data["@type"])return"";const t=e.msg_data.text;return(new TextDecoder).decode(TonWeb.utils.base64ToBytes(t))}const s=[],a=await this.ton.getTransactions(this.myAddress,e);for(let e of a){let a=new i(e.in_msg.value);for(let t of e.out_msgs)a=a.sub(new i(t.value));let o="",n="",r="";e.in_msg.source?(o=e.in_msg.source,n=e.in_msg.destination,r=t(e.in_msg)):e.out_msgs.length&&(o=e.out_msgs[0].source,n=e.out_msgs[0].destination,r=t(e.out_msgs[0])),n&&s.push({amount:a.toString(),from_addr:o,to_addr:n,fee:e.fee.toString(),storageFee:e.storage_fee.toString(),otherFee:e.other_fee.toString(),comment:r,date:1e3*e.utime})}return s}async sign(e,t,s,a){let o=(await this.getWallet(this.myAddress)).seqno;o||(o=0);const n=a?a.secretKey:null;return this.walletContract.methods.transfer({secretKey:n,toAddress:e,amount:t,seqno:o,payload:s,sendMode:3})}async showCreated(){this.sendToView("showScreen",{name:"created"}),this.sendToView("disableCreated",!0),this.myMnemonicWords=await TonWeb.mnemonic.generateMnemonic();const e=await w.wordsToPrivateKey(this.myMnemonicWords),t=r.sign.keyPair.fromSeed(TonWeb.utils.base64ToBytes(e)),s=this.ton.wallet.all.v3R2;this.walletContract=new s(this.ton.provider,{publicKey:t.publicKey,wc:0}),this.myAddress=(await this.walletContract.getAddress()).toString(!0,!0,!0),localStorage.setItem("walletVersion","v3R2"),this.sendToView("disableCreated",!1)}async createPrivateKey(){this.showBackup(this.myMnemonicWords)}onBackupWalletClick(){this.afterEnterPassword=async e=>{const t=await w.loadWords(e);this.showBackup(t)},this.sendToView("showPopup",{name:"enterPassword"})}showBackup(e){this.sendToView("showScreen",{name:"backup",words:e})}onBackupDone(){localStorage.getItem("words")?this.sendToView("showScreen",{name:"main"}):this.showCreatePassword()}async createLedger(e){let t;switch(e){case"hid":t=await TonWeb.ledger.TransportWebHID.create();break;case"ble":t=await TonWeb.ledger.BluetoothTransport.create();break;default:throw new Error("unknown transportType"+e)}t.setDebugMode(!0),this.isLedger=!0,this.ledgerApp=new TonWeb.ledger.AppTon(t,this.ton);const s=(await this.ledgerApp.getAppConfiguration()).version;if(console.log("ledgerAppConfig=",s),!s.startsWith("2"))throw alert("Please update your Ledger TON-app to v2.0.1 or upper or use old wallet version https://tonwallet.me/prev/"),new Error("outdated ledger ton-app version");const{publicKey:a}=await this.ledgerApp.getPublicKey(0,!1),o=new(0,this.ton.wallet.all.v3R1)(this.ton.provider,{publicKey:a,wc:0});this.walletContract=o;const n=await o.getAddress();this.myAddress=n.toString(!0,!0,!0),this.publicKeyHex=TonWeb.utils.bytesToHex(a)}async importLedger(e){await this.createLedger(e),localStorage.setItem("walletVersion",this.walletContract.getName()),localStorage.setItem("address",this.myAddress),localStorage.setItem("isLedger","true"),localStorage.setItem("ledgerTransportType",e),localStorage.setItem("pwdHash","ledger"),localStorage.setItem("words","ledger"),localStorage.setItem("publicKey",this.publicKeyHex),this.sendToView("setIsLedger",this.isLedger),this.sendToView("showScreen",{name:"readyToGo"})}showImport(){this.sendToView("showScreen",{name:"import"})}async import(e){if(this.myMnemonicWords=e,this.myMnemonicWords){const e=await w.wordsToPrivateKey(this.myMnemonicWords),t=r.sign.keyPair.fromSeed(TonWeb.utils.base64ToBytes(e));let s=[];for(let e of this.ton.wallet.list){const a=new e(this.ton.provider,{publicKey:t.publicKey,wc:0}),o=(await a.getAddress()).toString(!0,!0,!0),n=await this.ton.provider.getWalletInfo(o),r=this.getBalance(n);r.gt(new i(0))&&s.push({balance:r,clazz:e}),console.log(a.getName(),o,n,r.toString())}let a=this.ton.wallet.all.v3R2;s.length>0&&(s.sort((e,t)=>e.balance.cmp(t.balance)),a=s[s.length-1].clazz),await this.importImpl(t,a)}}async importImpl(e,t){this.walletContract=new t(this.ton.provider,{publicKey:e.publicKey,wc:0}),this.myAddress=(await this.walletContract.getAddress()).toString(!0,!0,!0),localStorage.setItem("walletVersion",this.walletContract.getName()),this.showCreatePassword()}showCreatePassword(){this.sendToView("showScreen",{name:"createPassword"})}async savePrivateKey(e){this.isLedger=!1,localStorage.setItem("isLedger","false"),localStorage.setItem("address",this.myAddress),await w.saveWords(this.myMnemonicWords,e);const t=await c(e);localStorage.setItem("pwdHash",t),this.myMnemonicWords=null,this.sendToView("setIsLedger",this.isLedger),this.sendToView("setPasswordHash",t),this.sendToView("showScreen",{name:"readyToGo"})}async onChangePassword(e,t){if(await c(e)!==localStorage.getItem("pwdHash"))return;const s=await w.loadWords(e);await w.saveWords(s,t);const a=await c(t);localStorage.setItem("pwdHash",a),this.sendToView("setPasswordHash",a),this.sendToView("closePopup")}async onEnterPassword(e){await c(e)===localStorage.getItem("pwdHash")&&this.afterEnterPassword(e)}showMain(){if(this.sendToView("showScreen",{name:"main",myAddress:this.myAddress}),this.sendToView("setPasswordHash",localStorage.getItem("pwdHash")),!this.walletContract){const e=localStorage.getItem("walletVersion"),t=e?this.ton.wallet.all[e]:this.ton.wallet.default;this.walletContract=new t(this.ton.provider,{address:this.myAddress,wc:0})}this.updateIntervalId=setInterval(()=>this.update(),5e3),this.update(),this.sendToDapp("ton_accounts",[this.myAddress])}initDapp(){this.sendToDapp("ton_accounts",this.myAddress?[this.myAddress]:[]),this.doMagic("true"===localStorage.getItem("magic")),this.doProxy("true"===localStorage.getItem("proxy"))}initView(){this.myAddress&&localStorage.getItem("words")&&localStorage.getItem("pwdHash")?(this.sendToView("showScreen",{name:"main",myAddress:this.myAddress}),null!==this.balance&&this.sendToView("setBalance",{balance:this.balance.toString(),txs:this.transactions}),this.sendToView("setPasswordHash",localStorage.getItem("pwdHash"))):this.sendToView("showScreen",{name:"start"}),this.sendToView("setIsMagic","true"===localStorage.getItem("magic")),this.sendToView("setIsProxy","true"===localStorage.getItem("proxy"))}update(){this.getWallet().then(e=>{const t=this.getBalance(e),s=null===this.balance||0!==this.balance.cmp(t);this.balance=t;const a=this.checkContractInitialized(e)&&e.seqno;console.log("isBalanceChanged",s),console.log("isContractInitialized",a),!this.isContractInitialized&&a&&(this.isContractInitialized=!0),s?this.getTransactions().then(e=>{if(e.length>0){this.transactions=e;const t=e.filter(e=>Number(e.date)>this.lastTransactionTime);if(this.lastTransactionTime=Number(e[0].date),this.processingVisible&&this.sendingData)for(let e of t){const t=new l(e.to_addr).toString(!0,!0,!0),s=new l(this.sendingData.toAddress).toString(!0,!0,!0),a=e.amount,o="-"+this.sendingData.amount.toString();if(t===s&&a===o){this.sendToView("showPopup",{name:"done",message:d(this.sendingData.amount)+" TON have been sent"}),this.processingVisible=!1,this.sendingData=null;break}}}this.sendToView("setBalance",{balance:t.toString(),txs:e})}):this.sendToView("setBalance",{balance:t.toString(),txs:this.transactions})})}async showAddressOnDevice(){this.ledgerApp||await this.createLedger(localStorage.getItem("ledgerTransportType")||"hid");const{address:e}=await this.ledgerApp.getAddress(0,!0,this.ledgerApp.ADDRESS_FORMAT_USER_FRIENDLY+this.ledgerApp.ADDRESS_FORMAT_URL_SAFE+this.ledgerApp.ADDRESS_FORMAT_BOUNCEABLE);console.log(e.toString(!0,!0,!0))}async getFees(e,t,s){if(!this.isContractInitialized)return TonWeb.utils.toNano(.010966001);try{const a=await this.sign(t,e,s,null),o=(await a.estimateFee()).source_fees,n=new i(o.in_fwd_fee),r=new i(o.storage_fee),l=new i(o.gas_fee),d=new i(o.fwd_fee);return n.add(r).add(l).add(d)}catch(e){return console.error(e),new i(0)}}async showSendConfirm(e,t,s,a){if(e.lte(0)||this.balance.lt(e))return;if(!l.isValid(t))return;const o=await this.getFees(e,t,s);this.isLedger?(this.sendToView("showPopup",{name:"sendConfirm",amount:e.toString(),toAddress:t,fee:o.toString()},a),this.send(t,e,s,null)):(this.afterEnterPassword=async a=>{const o=await w.loadWords(a);this.processingVisible=!0,this.sendToView("showPopup",{name:"processing"});const n=await w.wordsToPrivateKey(o);this.send(t,e,s,n)},this.sendToView("showPopup",{name:"sendConfirm",amount:e.toString(),toAddress:t,fee:o.toString()},a))}async send(e,t,s,a){try{let o=0;if(this.isLedger){this.ledgerApp||await this.createLedger(localStorage.getItem("ledgerTransportType")||"hid");const t=new l(e);t.isUserFriendly&&(o+=this.ledgerApp.ADDRESS_FORMAT_USER_FRIENDLY,t.isUrlSafe&&(o+=this.ledgerApp.ADDRESS_FORMAT_URL_SAFE),t.isBounceable&&(o+=this.ledgerApp.ADDRESS_FORMAT_BOUNCEABLE),t.isTestOnly&&(o+=this.ledgerApp.ADDRESS_FORMAT_TEST_ONLY))}if(this.checkContractInitialized(await this.ton.provider.getWalletInfo(e))||(e=new l(e).toString(!0,!0,!1)),this.isLedger){let a=(await this.getWallet(this.myAddress)).seqno;a||(a=0);const n=await this.ledgerApp.transfer(0,this.walletContract,e,t,a,o);this.sendingData={toAddress:e,amount:t,comment:s,query:n},this.sendToView("showPopup",{name:"processing"}),this.processingVisible=!0,await this.sendQuery(n)}else{const o=r.sign.keyPair.fromSeed(TonWeb.utils.base64ToBytes(a)),n=await this.sign(e,t,s,o);this.sendingData={toAddress:e,amount:t,comment:s,query:n},await this.sendQuery(n)}}catch(e){console.error(e),this.sendToView("closePopup"),alert("Error sending")}}async sendQuery(e){console.log("Send"),"ok"===(await e.send())["@type"]||(this.sendToView("closePopup"),alert("Send error"))}onDisconnectClick(){this.myAddress=null,this.publicKeyHex=null,this.balance=null,this.walletContract=null,this.transactions=[],this.lastTransactionTime=0,this.isContractInitialized=!1,this.sendingData=null,this.processingVisible=!1,this.isLedger=!1,this.ledgerApp=null,clearInterval(this.updateIntervalId),localStorage.clear(),this.sendToView("showScreen",{name:"start"}),this.sendToDapp("ton_accounts",[])}doMagic(e){try{chrome.browsingData.remove({origins:["https://web.telegram.org"]},{cache:!0}),this.sendToDapp("ton_doMagic",e)}catch(e){}}doProxy(e){}sendToView(e,t,s){if(window.view)window.view.onMessage(e,t);else{const n={method:e,params:t};a?a.postMessage(n):s&&o.push(n)}}onViewMessage(e,t){switch(e){case"showScreen":switch(t.name){case"created":this.showCreated();break;case"import":this.showImport();break;case"importLedger":this.importLedger(t.transportType)}break;case"import":this.import(t.words);break;case"createPrivateKey":this.createPrivateKey();break;case"passwordCreated":this.savePrivateKey(t.password);break;case"update":this.update();break;case"showAddressOnDevice":this.showAddressOnDevice();break;case"onEnterPassword":this.onEnterPassword(t.password);break;case"onChangePassword":this.onChangePassword(t.oldPassword,t.newPassword);break;case"onSend":this.showSendConfirm(new i(t.amount),t.toAddress,t.comment);break;case"onBackupDone":this.onBackupDone();break;case"showMain":this.showMain();break;case"onBackupWalletClick":this.onBackupWalletClick();break;case"disconnect":this.onDisconnectClick();break;case"onClosePopup":this.processingVisible=!1;break;case"onMagicClick":localStorage.setItem("magic",t?"true":"false"),this.doMagic(t);break;case"onProxyClick":localStorage.setItem("proxy",t?"true":"false"),this.doProxy(t)}}sendToDapp(e,t){s&&s.postMessage(JSON.stringify({type:"gramWalletAPI",message:{jsonrpc:"2.0",method:e,params:t}}))}async onDappMessage(e,t){switch(e){case"ton_requestAccounts":return this.myAddress?[this.myAddress]:[];case"ton_getBalance":return this.balance?this.balance.toString():"";case"ton_sendTransaction":const e=t[0],s=!a;return a||n(),this.showSendConfirm(new i(e.value),e.to,e.data,s),!0}}}const g=new w;chrome.runtime&&chrome.runtime.onConnect&&chrome.runtime.onConnect.addListener(e=>{"gramWalletContentScript"===e.name?(s=e,s.onMessage.addListener(async e=>{if(!e.message)return;const t=await g.onDappMessage(e.message.method,e.message.params);s&&s.postMessage(JSON.stringify({type:"gramWalletAPI",message:{jsonrpc:"2.0",id:e.message.id,method:e.message.method,result:t}}))}),s.onDisconnect.addListener(()=>{s=null}),g.initDapp()):"gramWalletPopup"===e.name&&(a=e,a.onMessage.addListener((function(e){g.onViewMessage(e.method,e.params)})),a.onDisconnect.addListener(()=>{a=null}),g.initView(),o.forEach(e=>a.postMessage(e)),o.length=0)})}]);